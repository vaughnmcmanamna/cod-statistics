<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COD Analytics - Professional Performance Analytics Platform</title>

    <!-- External Dependencies -->
    <script src="d3.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <div class="logo">üìä</div>
                <span class="brand-name">COD Analytics</span>
            </div>
            <ul class="nav-links">
                <li><a href="#dashboard" class="active" data-route="dashboard">Dashboard</a></li>
                <li><a href="#analytics" data-route="analytics">Analytics</a></li>
                <li><a href="#matches" data-route="matches">Matches</a></li>
            </ul>
            <div class="nav-actions">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode" id="themeToggle">
                    <span class="theme-icon">‚òÄÔ∏è</span>
                </button>
                <button class="btn-primary" onclick="openUploadModal()">üì§ Upload Data</button>
                <button class="btn-secondary" onclick="clearCachedData()" title="Clear cached data">üóëÔ∏è</button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">

        <!-- DASHBOARD VIEW -->
        <section id="dashboard-view" class="page-view active">
            <div class="page-header mb-8">
                <h1>Performance Dashboard</h1>
                <p class="text-secondary">Overview of your competitive performance metrics and trends</p>
            </div>

            <!-- Stats Summary Cards -->
            <div class="stats-summary" id="statsSummary">
                <!-- Populated dynamically by JavaScript -->
            </div>

            <!-- Dashboard Insights Section -->
            <div class="dashboard-insights-grid">
                <!-- Quick Insights Box -->
                <div id="quickInsights" class="dashboard-card">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Recent Streak Indicator -->
                <div id="recentStreak" class="dashboard-card">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Mini Map Veto Cheat Sheet -->
            <div id="miniVetoGuide" class="dashboard-card mt-6">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Quick Info -->
            <div class="dashboard-info-box">
                <p class="text-secondary" style="font-size: 0.95rem; margin: 0;">
                    üìä View detailed analytics in the <strong>Analytics</strong> tab above
                </p>
            </div>
        </section>

        <!-- MATCHES VIEW (Table) -->
        <section id="matches-view" class="page-view">
            <div class="page-header mb-8">
                <h1>Match History</h1>
                <p class="text-secondary">Detailed view of all your competitive matches</p>
            </div>

            <!-- Table Section (Placeholder for Phase 3) -->
            <div class="table-section">
                <div class="table-controls">
                    <div class="table-filters">
                        <input type="search" placeholder="Search matches..." id="tableSearch">
                        <select id="tableGameTypeFilter">
                            <option value="">All Game Types</option>
                        </select>
                        <select id="tableMapFilter">
                            <option value="">All Maps</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="exportTableToCSV()">Export CSV</button>
                </div>

                <div id="matches-table-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-title">Match Table Coming Soon</div>
                        <div class="empty-state-text">
                            The detailed match table view will be implemented in Phase 3.
                            For now, view your matches in the Dashboard.
                        </div>
                    </div>
                </div>

                <div class="table-pagination" id="tablePagination">
                    <!-- Pagination will be added in Phase 3 -->
                </div>
            </div>
        </section>

        <!-- ANALYTICS VIEW (Multiple Charts) -->
        <section id="analytics-view" class="page-view">
            <div class="page-header mb-8">
                <h1>Advanced Analytics</h1>
                <p class="text-secondary">Deep dive into performance metrics with multiple visualization types</p>
            </div>

            <!-- Chart Tabs -->
            <div class="chart-tabs mb-6">
                <button class="tab-btn active" data-chart="ranked-overview" onclick="switchAnalyticsChart('ranked-overview')">
                    üèÜ Ranked Overview
                </button>
                <button class="tab-btn" data-chart="map-veto" onclick="switchAnalyticsChart('map-veto')">
                    üö´ Map Veto Guide
                </button>
                <button class="tab-btn" data-chart="consistency" onclick="switchAnalyticsChart('consistency')">
                    üìä Consistency
                </button>
                <button class="tab-btn" data-chart="win-rate-grid" onclick="switchAnalyticsChart('win-rate-grid')">
                    üéØ Win Rate Grid
                </button>
                <button class="tab-btn" data-chart="map-performance" onclick="switchAnalyticsChart('map-performance')">
                    üó∫Ô∏è Map Performance
                </button>
                <button class="tab-btn" data-chart="time-of-day" onclick="switchAnalyticsChart('time-of-day')">
                    üïê Time of Day
                </button>
            </div>

            <!-- Ranked Overview Container -->
            <div id="ranked-overview-container" class="chart-section active-chart">
                <div class="chart-header">
                    <h3 class="chart-title">üèÜ Ranked Performance Overview</h3>
                    <p class="text-secondary">Your competitive performance on ranked maps and modes</p>
                </div>
                <div id="rankedOverviewStats" class="stats-grid mb-6"></div>
                <div class="chart-container" id="rankedOverviewChart"></div>
            </div>

            <!-- Map Veto Guide Container -->
            <div id="map-veto-container" class="chart-section">
                <div class="chart-header">
                    <h3 class="chart-title">üö´ Map Veto Recommendations</h3>
                    <p class="text-secondary">Which maps to ban based on your performance</p>
                </div>
                <div id="mapVetoContent"></div>
            </div>

            <!-- Consistency Container -->
            <div id="consistency-container" class="chart-section">
                <div class="chart-header">
                    <h3 class="chart-title">üìä Performance Consistency</h3>
                    <p class="text-secondary">How consistent are you across matches?</p>
                </div>
                <div id="consistencyStats" class="stats-grid mb-6"></div>
                <div class="chart-container" id="consistencyChart"></div>
            </div>

            <!-- Win Rate Grid Container -->
            <div id="win-rate-grid-container" class="chart-section">
                <div class="chart-header">
                    <h3 class="chart-title">üéØ Win Rate by Map & Mode</h3>
                    <p class="text-secondary">Heat map showing your win rates across all combinations ‚Ä¢ üèÜ Purple border = Ranked map/mode</p>
                </div>
                <div class="chart-container" id="winRateGridChart" style="overflow-x: auto; overflow-y: hidden; max-width: 100%;"></div>
            </div>

            <!-- Map Performance Container -->
            <div id="map-performance-container" class="chart-section">
                <div class="chart-header">
                    <h3 class="chart-title">Map Performance Analysis</h3>
                    <p class="text-secondary">Win rate and K/D ratio by map - identify your best and worst maps</p>
                </div>
                <div class="chart-container" id="mapPerformanceChart"></div>
            </div>

            <!-- Time of Day Container -->
            <div id="time-of-day-container" class="chart-section">
                <div class="chart-header">
                    <h3 class="chart-title">Performance by Time of Day</h3>
                    <p class="text-secondary">Identify your peak performance hours</p>
                </div>
                <div class="chart-container" id="timeOfDayChart"></div>
            </div>

            <!-- Session Fatigue Container -->
            <div id="session-fatigue-container" class="chart-section">
                <div class="chart-header">
                    <h3 class="chart-title">Session Fatigue Analysis</h3>
                    <p class="text-secondary">How your performance changes during long play sessions</p>
                </div>
                <div class="chart-container" id="sessionFatigueChart"></div>
            </div>

            <!-- Bar Chart Container -->
            <div id="bar-chart-container" class="chart-section">
                <div class="chart-header">
                    <h3 class="chart-title">Performance Comparison by Game Type</h3>
                    <div class="chart-controls">
                        <select id="barChartMetric" class="chart-select">
                            <option value="K/D Ratio">K/D Ratio</option>
                            <option value="EKIA/D Ratio">EKIA/D Ratio</option>
                            <option value="Skill">Skill Rating</option>
                            <option value="Score">Score</option>
                            <option value="Accuracy %">Accuracy %</option>
                            <option value="Headshot %">Headshot %</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" id="barChart"></div>
            </div>

            <!-- Donut Chart Container -->
            <div id="donut-chart-container" class="chart-section">
                <div class="chart-header">
                    <h3 class="chart-title">Win/Loss Distribution</h3>
                    <div class="chart-controls">
                        <select id="donutChartFilter" class="chart-select">
                            <option value="all">All Matches</option>
                            <option value="ranked">Ranked Only</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container donut-container" id="donutChart"></div>
            </div>

            <!-- Heatmap Container -->
            <div id="heatmap-container" class="chart-section">
                <div class="chart-header">
                    <h3 class="chart-title">Metric Correlation Heatmap</h3>
                    <p class="text-secondary">Shows how strongly different metrics are related to each other</p>
                </div>
                <div class="chart-container" id="heatmapChart"></div>
            </div>
        </section>

    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal-backdrop hidden" onclick="closeUploadModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Upload Match Data</h3>
                <button class="modal-close" onclick="closeUploadModal()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Sample Data Section -->
                <div class="sample-data-section">
                    <div class="sample-data-header">
                        <span class="sample-data-icon">üì¶</span>
                        <h4 class="sample-data-title">Don't have data? Try our sample files!</h4>
                    </div>
                    <p class="sample-data-desc">
                        Download sample CSV files to test the platform's features:
                    </p>
                    <div class="sample-links-container">
                        <a href="samples/competitive_player.csv" download class="sample-download-link">
                            <span class="sample-link-title">Competitive Player</span>
                            <span class="sample-link-desc">30 ranked matches ¬∑ High K/D ¬∑ 60% win rate</span>
                        </a>
                        <a href="samples/ranked_grinder.csv" download class="sample-download-link">
                            <span class="sample-link-title">Ranked Grinder</span>
                            <span class="sample-link-desc">63 ranked matches ¬∑ All maps/modes ¬∑ Mixed performance</span>
                        </a>
                        <a href="samples/casual_player.csv" download class="sample-download-link">
                            <span class="sample-link-title">Casual Player</span>
                            <span class="sample-link-desc">30 casual matches ¬∑ Various modes ¬∑ No ranked</span>
                        </a>
                    </div>
                </div>

                <!-- Divider -->
                <div class="modal-divider">
                    <div class="divider-line"></div>
                    <span class="divider-text">OR UPLOAD YOUR OWN</span>
                    <div class="divider-line"></div>
                </div>

                <p class="text-secondary mb-4">
                    Upload a CSV file containing your Call of Duty match data.
                    The data will be processed and displayed temporarily without database storage.
                </p>
                <div style="text-align: center;">
                    <input type="file" id="csvFileInput" accept=".csv" style="margin-bottom: 1rem;">
                    <p class="text-secondary" style="font-size: 0.75rem;">
                        Supported: .csv files only<br>
                        Data is temporary and will be lost on page refresh
                    </p>
                </div>
                <div id="uploadFeedback" style="margin-top: 1rem; min-height: 20px;"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeUploadModal()">Cancel</button>
                <button class="btn-primary" id="uploadButton" onclick="handleUpload()">Upload</button>
            </div>
        </div>
    </div>

    <!-- Toast Container (for notifications) -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-text">
                ¬© 2026 COD Analytics Platform. Built with D3.js, FastAPI & PostgreSQL.
            </div>
            <ul class="footer-links">
                <li><a href="#dashboard">Dashboard</a></li>
                <li><a href="#matches">Matches</a></li>
                <li><a href="#analytics">Analytics</a></li>
            </ul>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="script.js"></script>

    <!-- Initialize Router on Load -->
    <script>
        // Simple hash-based routing
        function initRouter() {
            function handleRoute() {
                const hash = window.location.hash.slice(1) || 'dashboard';

                // Hide all views
                document.querySelectorAll('.page-view').forEach(view => {
                    view.classList.remove('active');
                });

                // Show target view
                const targetView = document.getElementById(`${hash}-view`);
                if (targetView) {
                    targetView.classList.add('active');
                }

                // Update active nav link
                document.querySelectorAll('.nav-links a').forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('data-route') === hash) {
                        link.classList.add('active');
                    }
                });

                // Re-render analytics charts when analytics view becomes active
                if (hash === 'analytics' && window.state && window.state.data) {
                    setTimeout(() => {
                        if (typeof renderAdvancedAnalytics === 'function') {
                            renderAdvancedAnalytics(window.state.data);
                        }
                    }, 50);
                }
            }

            window.addEventListener('hashchange', handleRoute);
            handleRoute(); // Initial route
        }

        // Modal functions
        function openUploadModal() {
            document.getElementById('uploadModal').classList.remove('hidden');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('csvFileInput').value = '';
            document.getElementById('uploadFeedback').textContent = '';
        }

        // Initialize router when page loads
        window.addEventListener('load', initRouter);
    </script>
</body>
</html>
